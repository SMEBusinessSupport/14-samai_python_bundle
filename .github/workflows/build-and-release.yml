name: Build and Release Python Bundle

on:
  push:
    paths:
      - 'requirements.txt'
      - '.github/workflows/build-and-release.yml'
    branches:
      - main
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag (e.g., v3.12.10.1-odoo18-1)'
        required: false
        default: ''

jobs:
  build-bundle:
    name: Build Clean Python Bundle
    runs-on: windows-latest

    permissions:
      contents: write  # Needed to create releases

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Create portable Python bundle
        run: |
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host "Creating portable Python bundle" -ForegroundColor Cyan
          Write-Host "============================================" -ForegroundColor Cyan

          # Create bundle directory structure
          New-Item -ItemType Directory -Path "python-bundle" -Force | Out-Null

          # Get Python location
          $pythonExe = (Get-Command python).Source
          $pythonRoot = Split-Path $pythonExe

          Write-Host "Python location: $pythonRoot" -ForegroundColor Gray

          # Copy Python installation
          Copy-Item -Path "$pythonRoot\*" -Destination "python-bundle\" -Recurse -Force

          Write-Host "Python bundle created" -ForegroundColor Green
        shell: pwsh

      - name: Upgrade pip
        run: |
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host "Upgrading pip" -ForegroundColor Cyan
          Write-Host "============================================" -ForegroundColor Cyan

          & "python-bundle\Scripts\pip.exe" install --upgrade pip setuptools wheel

          Write-Host "pip upgraded" -ForegroundColor Green
        shell: pwsh

      - name: Install requirements
        run: |
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host "Installing Python packages (Windows-optimized)" -ForegroundColor Cyan
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host "This may take 10-15 minutes..." -ForegroundColor Yellow
          Write-Host ""

          # Install packages individually for Windows compatibility
          # (requirements.txt is for Linux, many packages don't work on Windows)

          Write-Host "Installing Odoo core dependencies..." -ForegroundColor Cyan

          $odooPackages = @(
            "Babel==2.10.3",
            "chardet==5.2.0",
            "cryptography==42.0.8",
            "decorator==5.1.1",
            "docutils==0.20.1",
            "freezegun==1.2.1",
            "geoip2==2.9.0",
            "idna==3.6",
            "Jinja2==3.1.2",
            "libsass==0.22.0",
            "lxml==5.2.1",
            "lxml-html-clean",
            "MarkupSafe==2.1.5",
            "num2words==0.5.13",
            "ofxparse==0.21",
            "openpyxl==3.1.2",
            "passlib==1.7.4",
            "Pillow==10.2.0",
            "polib==1.1.1",
            "psutil==5.9.8",
            "psycopg2-binary==2.9.9",  # CRITICAL: Use -binary for Windows
            "pyopenssl==24.1.0",
            "PyPDF2==2.12.1",
            "pypiwin32",
            "pyserial==3.5",
            "python-dateutil==2.8.2",
            "python-stdnum==1.19",
            "pytz",
            "pyusb==1.2.1",
            "qrcode==7.4.2",
            "reportlab==4.1.0",
            "requests==2.31.0",
            "rjsmin==1.2.0",
            "rl-renderPM==4.0.3",
            "urllib3==2.0.7",
            "vobject==0.9.6.1",
            "Werkzeug==3.0.1",
            "xlrd==2.0.1",
            "XlsxWriter==3.1.9",
            "xlwt==1.3.0",
            "zeep==4.2.1"
          )

          foreach ($pkg in $odooPackages) {
            Write-Host "  Installing $pkg" -ForegroundColor Gray
            & "python-bundle\Scripts\pip.exe" install $pkg --no-warn-script-location 2>&1 | Out-Null
            if ($LASTEXITCODE -ne 0) {
              Write-Host "    WARNING: Failed to install $pkg" -ForegroundColor Yellow
            }
          }

          Write-Host ""
          Write-Host "Installing SAM AI dependencies..." -ForegroundColor Cyan

          $samaiPackages = @(
            "anthropic>=0.18.0",
            "openai>=1.0.0",
            "chromadb>=0.4.22",
            "sentence-transformers>=2.2.0",
            "beautifulsoup4>=4.11.0",
            "GitPython>=3.1.43"
          )

          foreach ($pkg in $samaiPackages) {
            Write-Host "  Installing $pkg" -ForegroundColor Gray
            & "python-bundle\Scripts\pip.exe" install $pkg --no-warn-script-location
            if ($LASTEXITCODE -ne 0) {
              Write-Host "    ERROR: Failed to install $pkg" -ForegroundColor Red
              exit 1
            }
          }

          Write-Host ""
          Write-Host "Installation complete" -ForegroundColor Green
        shell: pwsh

      - name: Validate bundle
        run: |
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host "Validating Bundle" -ForegroundColor Cyan
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host ""

          # Test critical imports
          $testPackages = @(
            @{Name="psycopg2"; Import="import psycopg2"},
            @{Name="lxml"; Import="import lxml"},
            @{Name="Pillow"; Import="from PIL import Image"},
            @{Name="werkzeug"; Import="import werkzeug"},
            @{Name="jinja2"; Import="import jinja2"},
            @{Name="babel"; Import="import babel"},
            @{Name="anthropic"; Import="import anthropic"},
            @{Name="openai"; Import="import openai"},
            @{Name="chromadb"; Import="import chromadb"},
            @{Name="sentence_transformers"; Import="import sentence_transformers"},
            @{Name="git (GitPython)"; Import="import git"}
          )

          $allOK = $true
          foreach ($package in $testPackages) {
            try {
              & "python-bundle\python.exe" -c $package.Import 2>&1 | Out-Null
              if ($LASTEXITCODE -eq 0) {
                Write-Host "  [OK] $($package.Name)" -ForegroundColor Green
              } else {
                Write-Host "  [FAIL] $($package.Name)" -ForegroundColor Red
                $allOK = $false
              }
            } catch {
              Write-Host "  [FAIL] $($package.Name)" -ForegroundColor Red
              $allOK = $false
            }
          }

          if (-not $allOK) {
            Write-Host ""
            Write-Host "Validation FAILED - some packages cannot be imported" -ForegroundColor Red
            exit 1
          }

          Write-Host ""
          Write-Host "All validation tests PASSED" -ForegroundColor Green
        shell: pwsh

      - name: Create bundle statistics
        id: stats
        run: |
          $bundleSize = (Get-ChildItem -Path "python-bundle" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          $packageCount = (& "python-bundle\Scripts\pip.exe" list --format=freeze | Measure-Object -Line).Lines

          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host "Bundle Statistics" -ForegroundColor Cyan
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host "Size: $([math]::Round($bundleSize, 2)) MB" -ForegroundColor White
          Write-Host "Packages: $packageCount installed" -ForegroundColor White
          Write-Host "Python: WinPython 3.12.10.1" -ForegroundColor White
          Write-Host "Environment: Clean GitHub Actions VM" -ForegroundColor Green
          Write-Host "============================================" -ForegroundColor Cyan

          # Output for release notes
          echo "bundle_size=$([math]::Round($bundleSize, 2))" >> $env:GITHUB_OUTPUT
          echo "package_count=$packageCount" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Compress bundle
        run: |
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host "Compressing bundle" -ForegroundColor Cyan
          Write-Host "============================================" -ForegroundColor Cyan

          Compress-Archive -Path "python-bundle\*" -DestinationPath "samai-python-bundle.zip" -CompressionLevel Optimal

          $zipSize = (Get-Item "samai-python-bundle.zip").Length / 1MB
          Write-Host "Compressed size: $([math]::Round($zipSize, 2)) MB" -ForegroundColor Green
        shell: pwsh

      - name: Generate version tag
        id: version
        run: |
          if ("${{ github.event.inputs.version_tag }}" -ne "") {
            $tag = "${{ github.event.inputs.version_tag }}"
          } else {
            $date = Get-Date -Format "yyyyMMdd-HHmmss"
            $tag = "v3.12.10.1-odoo18-$date"
          }

          Write-Host "Version tag: $tag" -ForegroundColor Cyan
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Python Bundle ${{ steps.version.outputs.tag }}
          body: |
            # SAM AI Python Bundle

            **Built in clean GitHub Actions environment** - No contamination guaranteed

            ## Bundle Details
            - **Python Version:** WinPython 3.12.10.1
            - **Bundle Size:** ${{ steps.stats.outputs.bundle_size }} MB
            - **Packages:** ${{ steps.stats.outputs.package_count }} installed
            - **Environment:** Fresh Windows VM (no Python pre-installed)
            - **Built:** ${{ github.run_id }}

            ## Included Packages
            - All Odoo 18 dependencies
            - SAM AI packages: anthropic, openai, chromadb, sentence-transformers, GitPython
            - Full requirements.txt from commit ${{ github.sha }}

            ## How to Use

            1. Download `samai-python-bundle.zip`
            2. Extract to your installer project's `bundled/python/` directory
            3. Build installer

            ## Verification
            All critical imports tested and validated before release.
          files: |
            samai-python-bundle.zip
          draft: false
          prerelease: false

      - name: Success summary
        run: |
          Write-Host ""
          Write-Host "============================================" -ForegroundColor Green
          Write-Host "RELEASE CREATED SUCCESSFULLY" -ForegroundColor Green
          Write-Host "============================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Tag: ${{ steps.version.outputs.tag }}" -ForegroundColor Cyan
          Write-Host "Size: ${{ steps.stats.outputs.bundle_size }} MB" -ForegroundColor Cyan
          Write-Host "Packages: ${{ steps.stats.outputs.package_count }}" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Download from:" -ForegroundColor Yellow
          Write-Host "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}" -ForegroundColor White
          Write-Host ""
        shell: pwsh
